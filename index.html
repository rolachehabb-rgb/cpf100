<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>CPF100 ‚Äî Capsule Centenaire</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,700;9..144,800&family=Outfit:wght@400;600;800&family=Oooh+Baby&display=swap" rel="stylesheet">

  <style>
    :root{
      --cpf-r:#ff3b5c; --cpf-g:#22d38a; --cpf-y:#ffd24a; --cpf-b:#2f7bff;
      --ink:#101326;
      --glass:rgba(255,255,255,.62);
      --card:rgba(255,255,255,.86);
      --shadow:0 26px 80px rgba(0,0,0,.14);
      --shadow2:0 14px 40px rgba(0,0,0,.10);
      --round:36px;
      --sans:"Outfit", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --serif:"Fraunces", ui-serif, Georgia, serif;
      --hand:"Oooh Baby", cursive;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      font-family:var(--sans);
      overflow-y:auto;
      overflow-x:hidden;
      background:#fff;
      letter-spacing:-.01em;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .aura{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(1100px 720px at 6% 8%, rgba(255,215,233,.78), transparent 60%),
        radial-gradient(1100px 720px at 95% 10%, rgba(215,236,255,.82), transparent 60%),
        radial-gradient(1100px 720px at 10% 94%, rgba(214,255,240,.68), transparent 60%),
        radial-gradient(1100px 720px at 92% 92%, rgba(255,244,205,.68), transparent 60%);
      filter:saturate(1.06);
    }

    .paper{
      position:fixed; inset:-120px; z-index:0; pointer-events:none;
      background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='360' height='220' viewBox='0 0 360 220'>\
<rect width='360' height='220' fill='white'/>\
<g fill='none' stroke='rgba(47,123,255,0.10)' stroke-width='1.2'>\
<path d='M-40 28 C 56 10, 124 46, 220 28 S 304 46, 400 28'/>\
<path d='M-40 72 C 56 54, 124 90, 220 72 S 304 90, 400 72'/>\
<path d='M-40 116 C 56 98, 124 134, 220 116 S 304 134, 400 116'/>\
<path d='M-40 160 C 56 142, 124 178, 220 160 S 304 178, 400 160'/>\
<path d='M-40 204 C 56 186, 124 222, 220 204 S 304 222, 400 204'/>\
</g></svg>");
      background-repeat:repeat;
      opacity:1;
    }

    .sparkles{position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.55}
    .sp{position:absolute; width:14px; height:14px; border-radius:999px; filter: blur(.2px);
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,0));
        animation: float 10s ease-in-out infinite;
    }
    .sp::after{content:""; position:absolute; inset:-3px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.6), rgba(255,255,255,0));
      opacity:.55;
    }
    @keyframes float{
      0%,100%{transform:translateY(0) translateX(0); opacity:.6}
      50%{transform:translateY(-16px) translateX(8px); opacity:1}
    }

    .stickers{position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.58}
    .s{position:absolute; filter: drop-shadow(0 18px 28px rgba(0,0,0,.10)); animation: bob 10s ease-in-out infinite}
    .s1{left:5%; top:12%; width:78px}
    .s2{right:5.5%; top:13%; width:74px; animation-duration:9.2s}
    .s3{left:6%; bottom:10%; width:86px; animation-duration:10.6s}
    .s4{right:6%; bottom:12%; width:80px; animation-duration:9.8s}
    @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-11px)}}

    #confetti{position:fixed; inset:0; pointer-events:none; z-index:10}

    .toast{
      position:fixed; left:50%; bottom:18px; z-index:11;
      transform:translateX(-50%) translateY(18px);
      background:rgba(16,19,38,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:16px;
      box-shadow:0 18px 48px rgba(0,0,0,.26);
      opacity:0;
      transition: all .22s ease;
      font-weight:800;
      max-width:min(720px, 92vw);
      text-align:center;
      letter-spacing:.02em;
      backdrop-filter: blur(10px);
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    .stage{
      position:relative; z-index:1;
      height:100%;
      display:grid; place-items:center;
      padding:22px;
    }
    .frame{
      width:min(980px, 94vw);
      height:min(720px, 90vh);
      border-radius:46px;
      background:var(--glass);
      border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }

    .topbar{
      height:70px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(0,0,0,.08);
      background:rgba(255,255,255,.78);
    }
    .miniBrand{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      background:rgba(255,255,255,.94);
      box-shadow:var(--shadow2);
      font-weight:900;
      letter-spacing:.02em;
    }
    .dots{display:flex; gap:6px}
    .dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(0,0,0,.10)}
    .dot.r{background:var(--cpf-r)} .dot.g{background:var(--cpf-g)} .dot.y{background:var(--cpf-y)} .dot.b{background:var(--cpf-b)}

    .tog{display:flex; gap:10px}
    .iconBtn{
      width:46px;height:46px;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.94);
      box-shadow:var(--shadow2);
      display:grid; place-items:center;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .2s ease;
      user-select:none; -webkit-tap-highlight-color:transparent;
    }
    .iconBtn:hover{transform:translateY(-1px); box-shadow:0 18px 44px rgba(0,0,0,.14)}
    .iconBtn:active{transform:translateY(0) scale(.99)}
    .iconBtn[data-on="false"]{opacity:.55; filter:grayscale(1)}
    .icon{width:22px;height:22px; opacity:.8}

    .pages{position:absolute; inset:70px 0 0 0; padding:18px;}
    .page{
      position:absolute; inset:18px;
      border-radius:var(--round);
      background:var(--card);
      border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow2);
      padding:28px 28px 22px;
      display:flex; flex-direction:column; gap:16px;
      opacity:0; transform: translateY(18px) scale(.995);
      pointer-events:none;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }
    .page.active{
      opacity:1; transform: translateY(0) scale(1);
      pointer-events:auto;
      animation: pageIn .55s cubic-bezier(.2,.9,.2,1);
    }
    @keyframes pageIn{from{opacity:0; transform:translateY(26px) scale(.99)}to{opacity:1; transform:translateY(0) scale(1)}}
    .page.out{animation: pageOut .22s ease forwards}
    @keyframes pageOut{to{opacity:0; transform:translateY(-10px) scale(.995)}}

    .titleCenter{margin-top:14px; text-align:center; display:grid; gap:10px; place-items:center}
    h1{
      margin:0;
      font-family:var(--serif);
      font-size:52px;
      line-height:1.0;
      letter-spacing:-.05em;
    }
    .sub{
      font-family:var(--hand);
      font-size:24px;
      color:rgba(16,19,38,.72);
      transform: rotate(-1.2deg);
      margin-top:-2px;
      text-align:center;
    }

    h2{
      margin:0;
      font-family:var(--serif);
      font-size:34px;
      line-height:1.05;
      letter-spacing:-.03em;
      text-align:center;
      margin-top:4px;
    }

    .card{
      border-radius:28px;
      border:1px solid rgba(0,0,0,.08);
      background:rgba(255,255,255,.92);
      box-shadow:var(--shadow2);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .card.tint1{background:linear-gradient(180deg, rgba(255,217,230,.52), rgba(255,255,255,.92));}
    .card.tint2{background:linear-gradient(180deg, rgba(214,255,240,.52), rgba(255,255,255,.92));}
    .card.tint3{background:linear-gradient(180deg, rgba(255,244,205,.56), rgba(255,255,255,.92));}
    .card.tint4{background:linear-gradient(180deg, rgba(215,236,255,.60), rgba(255,255,255,.92));}

    .card::before{
      content:"";
      position:absolute; inset:-70px -80px auto auto;
      width:250px; height:250px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,59,92,.14), transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(47,123,255,.14), transparent 60%);
      transform: rotate(12deg);
      opacity:.7;
      pointer-events:none;
    }

    .q{
      position:relative;
      font-size:18px;
      font-weight:900;
      line-height:1.35;
      color:rgba(16,19,38,.86);
    }

    /* ‚úÖ pour que Q3 et Q4 rentrent mieux */
    .q.small{
      font-size:15.5px;
      line-height:1.28;
    }
    .q.small .choice{
      font-weight:800;
      margin-top:6px;
      font-size:14.5px;
      line-height:1.22;
    }

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center}

    input{
      font-family:var(--sans);
      padding:13px 14px;
      border-radius:18px;
      border:2px solid rgba(0,0,0,.14);
      background:rgba(255,255,255,.98);
      min-width:280px;
      outline:none;
      box-shadow: inset 0 2px 0 rgba(0,0,0,.04);
      transition: border-color .2s ease, box-shadow .2s ease, transform .12s ease;
      font-size:16px;
      font-weight:700;
    }
    input:focus{
      border-color: rgba(47,123,255,.45);
      box-shadow: 0 0 0 7px rgba(47,123,255,.10), inset 0 2px 0 rgba(0,0,0,.04);
      transform: translateY(-1px);
    }
    input::placeholder{opacity:.55; font-weight:700}

    button{
      font-family:var(--sans);
      padding:13px 16px;
      border-radius:18px;
      border:2px solid rgba(0,0,0,.14);
      background:rgba(255,255,255,.96);
      cursor:pointer;
      font-weight:900;
      box-shadow:var(--shadow2);
      transition: transform .10s ease, box-shadow .2s ease, filter .2s ease;
      -webkit-tap-highlight-color: transparent;
      font-size:15px;
    }
    button:hover{transform:translateY(-1px); box-shadow:0 18px 44px rgba(0,0,0,.14)}
    button:active{transform:translateY(0) scale(.99)}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .primary{
      border-color: rgba(47,123,255,.18);
      background: linear-gradient(135deg, rgba(47,123,255,.22), rgba(255,255,255,1));
    }
    .soft{
      border-color: rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      font-weight:900;
    }

    .nav{
      margin-top:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding-top:10px;
    }
    .bar{
      width:250px; height:10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.05);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--cpf-r), var(--cpf-g), var(--cpf-y), var(--cpf-b));
      transition: width .3s ease;
    }
    .micro{
      font-size:12px;
      font-weight:800;
      color:rgba(16,19,38,.56);
      letter-spacing:.02em;
      margin-top:8px;
      min-height:18px;
    }
    .micro.ok{color:rgba(34,211,138,.95)}
    .micro.no{color:rgba(255,59,92,.92)}

    /* final */
    .finalGrid{
      display:grid;
      grid-template-columns: 1.12fr .88fr;
      gap:18px;
      align-items:center;
    }
    @media (max-width:820px){ .finalGrid{grid-template-columns:1fr} }
    .chestCard{
      border-radius:28px;
      border:1px solid rgba(0,0,0,.08);
      background:rgba(255,255,255,.92);
      box-shadow:var(--shadow2);
      padding:14px;
      display:grid; place-items:center;
      overflow:hidden;
      position:relative;
      min-height:280px;
    }
    .shake{animation: shake .7s ease-in-out infinite;}
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      10%{transform:translateX(-2px)}
      20%{transform:translateX(2px)}
      30%{transform:translateX(-3px)}
      40%{transform:translateX(3px)}
      50%{transform:translateX(-2px)}
      60%{transform:translateX(2px)}
      70%{transform:translateX(-1px)}
      80%{transform:translateX(1px)}
      90%{transform:translateX(0)}
    }
    .burstCoins{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0; transform:translateY(10px) scale(.98);
    }
    .burstCoins.show{
      opacity:1; transform:translateY(0) scale(1);
      transition: opacity .25s ease, transform .25s ease;
    }

    @media (max-width:520px){
      .frame{
        height:auto;
        min-height:100vh;
      input{min-width:220px}
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
    }
  </style>
</head>

<body>
  <div class="aura"></div>
  <div class="paper"></div>

  <div class="sparkles" aria-hidden="true">
    <div class="sp" style="left:14%; top:24%; animation-duration:9.6s;"></div>
    <div class="sp" style="left:82%; top:22%; animation-duration:10.3s;"></div>
    <div class="sp" style="left:22%; top:78%; animation-duration:11.1s;"></div>
    <div class="sp" style="left:76%; top:74%; animation-duration:9.9s;"></div>
  </div>

  <div class="stickers" aria-hidden="true">
    <svg class="s s1" viewBox="0 0 120 120">
      <path d="M26 70c12-30 56-36 74-10 20 28-8 58-38 50-22-6-48-14-36-40z"
        fill="rgba(255,217,230,.84)" stroke="rgba(0,0,0,.14)" stroke-width="3" stroke-linecap="round"/>
      <circle cx="52" cy="56" r="3.5" fill="rgba(0,0,0,.22)"/><circle cx="74" cy="56" r="3.5" fill="rgba(0,0,0,.22)"/>
      <path d="M48 66c10 8 20 8 30 0" fill="none" stroke="rgba(0,0,0,.16)" stroke-width="4" stroke-linecap="round"/>
    </svg>

    <svg class="s s2" viewBox="0 0 120 120">
      <rect x="24" y="28" width="72" height="70" rx="18"
        fill="rgba(215,236,255,.88)" stroke="rgba(0,0,0,.12)" stroke-width="3"/>
      <path d="M38 54h44" stroke="rgba(0,0,0,.14)" stroke-width="4" stroke-linecap="round"/>
      <path d="M38 70h36" stroke="rgba(0,0,0,.14)" stroke-width="4" stroke-linecap="round"/>
      <circle cx="82" cy="42" r="7" fill="rgba(255,59,92,.30)"/>
    </svg>

    <svg class="s s3" viewBox="0 0 140 140">
      <path d="M36 96c-10-40 28-74 66-62 30 10 42 46 26 72-18 30-78 32-92-10z"
        fill="rgba(214,255,240,.88)" stroke="rgba(0,0,0,.12)" stroke-width="3"/>
      <path d="M52 86c20 12 50 10 64-8" fill="none" stroke="rgba(0,0,0,.14)" stroke-width="4" stroke-linecap="round"/>
    </svg>

    <svg class="s s4" viewBox="0 0 120 120">
      <path d="M30 86c-10-22 6-50 32-56 26-6 50 12 50 38 0 22-20 36-44 34-18-2-30-6-38-16z"
        fill="rgba(255,244,205,.92)" stroke="rgba(0,0,0,.12)" stroke-width="3"/>
      <path d="M48 66c10-8 20-8 30 0" fill="none" stroke="rgba(0,0,0,.14)" stroke-width="4" stroke-linecap="round"/>
    </svg>
  </div>

  <canvas id="confetti"></canvas>
  <div class="toast" id="toast"></div>

  <div class="stage">
    <div class="frame">
      <div class="topbar">
        <div class="miniBrand">
          <span class="dots"><span class="dot r"></span><span class="dot g"></span><span class="dot y"></span><span class="dot b"></span></span>
          CPF100
        </div>

        <div class="tog">
          <div class="iconBtn" id="soundBtn" data-on="true" title="Son">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M11 5 7 9H4v6h3l4 4V5Z" stroke="rgba(0,0,0,.70)" stroke-width="2" stroke-linejoin="round"/>
              <path d="M15.5 8.5c1.5 1.5 1.5 5.5 0 7" stroke="rgba(0,0,0,.55)" stroke-width="2" stroke-linecap="round"/>
              <path d="M18 6c3 3 3 9 0 12" stroke="rgba(0,0,0,.40)" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>

          <div class="iconBtn" id="fxBtn" data-on="true" title="Effets">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 2l1.4 4.6L18 8l-4.6 1.4L12 14l-1.4-4.6L6 8l4.6-1.4L12 2Z" stroke="rgba(0,0,0,.70)" stroke-width="2" stroke-linejoin="round"/>
              <path d="M19 14l.9 3L23 18l-3.1 1L19 22l-.9-3L15 18l3.1-1L19 14Z" stroke="rgba(0,0,0,.45)" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="pages" id="pages"></div>
    </div>
  </div>

<script>
(() => {
  /* =========================================================
     CONFIG : TES 7 √âNONC√âS + R√âPONSES (non affich√©es)
     ========================================================= */
  const CONFIG = {
    title: "Capsule Centenaire",
    subtitle: "Chasse au tr√©sor ‚Äî √©dition maths ‚ú®",

    questions: [
      {
        id: 1,
        type: "text",
        label: "√ânonc√© n¬∞1 ‚Äî Math√©maticien",
        tint: "tint1",
        promptHTML: `
          Un math√©maticien de l‚ÄôAntiquit√© a profond√©ment marqu√© l‚Äôhistoire des math√©matiques gr√¢ce √† un th√©or√®me fondamental reliant les longueurs des c√¥t√©s d‚Äôun triangle rectangle.<br><br>
          Ce th√©or√®me est encore enseign√© aujourd‚Äôhui au coll√®ge et au lyc√©e.<br><br>
          <b>Quel est le nom de ce math√©maticien ?</b>
        `,
        placeholder: "R√©ponse",
        hint: "Indice : th√©or√®me dans triangle rectangle.",
        answer: "Pythagore"
      },

      {
        id: 2,
        type: "number",
        label: "√ânonc√© n¬∞2 ‚Äî Calcul (1925)",
        tint: "tint2",
        promptHTML: `
          Le CPF a √©t√© fond√© en 1925.<br><br>
          On te donne l‚Äôexpression suivante :<br>
          <b>N = 1¬≤ + 9¬≤ + 2¬≤ + 5¬≤</b><br><br>
          <b>Calculer la valeur de cette expression.</b>
        `,
        placeholder: "R√©ponse",
        hint: "Indice : calcule chaque carr√© puis additionne.",
        answer: 111
      },

      {
        id: 3,
        type: "letter",
        label: "√ânonc√© n¬∞3 ‚Äî Allure de la courbe",
        tint: "tint3",
        promptClass: "small",
        promptHTML: `
          On consid√®re la fonction d√©finie sur ‚Ñù par :<br>
          <b>f(x) = x¬≤ ‚àí 6x + 5</b><br><br>
          La courbe repr√©sentative de <b>f</b> est :<br>
          <div class="choice">A. Une parabole ouverte vers le haut, dont le sommet est un minimum, et dont le minimum est strictement n√©gatif.</div>
          <div class="choice">B. Une parabole ouverte vers le bas, dont le sommet est un maximum.</div>
          <div class="choice">C. Une droite d√©croissante.</div>
          <div class="choice">D. Une parabole ouverte vers le haut, dont le sommet est situ√© sur l‚Äôaxe des abscisses.</div>
          <br>
          <b>Choisir la bonne r√©ponse : A, B, C ou D.</b>
        `,
        placeholder: "R√©ponse",
        hint: "Indice : parabole (a>0) + sommet √† x = 3.",
        answer: "A"
      },

      {
        id: 4,
        type: "number",
        label: "√ânonc√© n¬∞4 ‚Äî Probabilit√©s",
        tint: "tint4",
        promptClass: "small",
        promptHTML: `
          On observe le d√©roulement d‚Äôune activit√© organis√©e au CPF.<br><br>
          On note :<br>
          <b>R</b> : ¬´ l‚Äô√©l√®ve participe √† l‚Äôactivit√© ¬ª<br>
          <b>S</b> : ¬´ l‚Äôactivit√© est r√©ussie ¬ª<br><br>
          On sait que :<br>
          <b>P(R) = 0,40</b><br>
          <b>P(S|R) = 0,50</b><br>
          <b>P(S|RÃÑ) = 0,20</b><br><br>
          <b>D√©terminer la probabilit√© P(S).</b>
        `,
        placeholder: "R√©ponse",
        hint: "Indice : formule des probabilit√©s totales.",
        answer: 0.32
      },

      {
        id: 5,
        type: "code",
        label: "√ânonc√© n¬∞5 ‚Äî Code de la capsule",
        tint: "tint1",
        promptHTML: `
          Une capsule du centenaire est prot√©g√©e par un code entier √† quatre chiffres, not√© <b>ABCD</b>.<br><br>
          Ce code v√©rifie les conditions suivantes :<br>
          ‚Ä¢ les deux premiers chiffres forment le nombre <b>65</b><br>
          ‚Ä¢ les deux derniers chiffres sont des <b>nombres premiers</b><br>
          ‚Ä¢ la somme des deux derniers chiffres est √©gale √† <b>12</b><br>
          ‚Ä¢ le chiffre des unit√©s est strictement inf√©rieur au chiffre des dizaines<br><br>
          <b>D√©terminer le code ABCD.</b>
        `,
        placeholder: "R√©ponse",
        hint: "Indice : cherche 2 chiffres premiers qui font 12 et unit√©s < dizaines.",
        answer: "6575"
      },

      {
        id: 6,
        type: "number",
        label: "√ânonc√© n¬∞6 ‚Äî G√©om√©trie",
        tint: "tint2",
        promptHTML: `
          On consid√®re un rectangle.<br><br>
          Sa largeur est not√©e <b>x</b> et sa longueur est √©gale √† <b>x + 4</b>.<br><br>
          Son p√©rim√®tre est √©gal √† <b>28</b>.<br><br>
          <b>Calculer l‚Äôaire de ce rectangle.</b>
        `,
        placeholder: "R√©ponse",
        hint: "Indice : 2(x + x+4)=28.",
        answer: 45
      },

      {
        id: 7,
        type: "system",
        label: "√ânonc√© n¬∞7 ‚Äî Syst√®me d‚Äô√©quations",
        tint: "tint3",
        promptHTML: `
          On consid√®re le syst√®me suivant :<br><br>
          <b>
          {<br>
          3x ‚àí y = 11<br>
          x + y = 13<br>
          }
          </b><br><br>
          <b>D√©terminer les valeurs de x et de y.</b>
        `,
        placeholder: "x;y",
        hint: "Indice : additionne (ou remplace) pour √©liminer y.",
        answer: "6;7"
      }
    ]
  };

  /* =========================
     Helpers / UI
     ========================= */
  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>document.querySelectorAll(q);

  const toast = $("#toast");
  let tt=null;
  function pop(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(tt);
    tt=setTimeout(()=>toast.classList.remove("show"), 900);
  }

  // audio
  let ac=null;
  let soundOn=true, fxOn=true;
  function initAudio(){ if(ac) return; try{ ac = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} }
  function beep(freq=520, dur=0.06, type="triangle", vol=0.028){
    if(!soundOn) return;
    initAudio(); if(!ac) return;
    const o=ac.createOscillator(), g=ac.createGain();
    o.type=type; o.frequency.value=freq;
    const t=ac.currentTime;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.connect(g); g.connect(ac.destination);
    o.start(t); o.stop(t+dur+0.04);
  }
  function winSound(){ beep(760,.05); setTimeout(()=>beep(980,.06), 70); }
  function failSound(){ beep(220,.08,"sawtooth",.024); setTimeout(()=>beep(170,.08,"sawtooth",.024), 90); }
  addEventListener("pointerdown", ()=>initAudio(), {once:false});

  const soundBtn=$("#soundBtn"), fxBtn=$("#fxBtn");
  function setOn(el,val){ el.setAttribute("data-on", String(val)); }
  setOn(soundBtn,true); setOn(fxBtn,true);
  soundBtn.addEventListener("click", ()=>{ soundOn=!soundOn; setOn(soundBtn,soundOn); beep(soundOn?820:320,.05); });
  fxBtn.addEventListener("click", ()=>{ fxOn=!fxOn; setOn(fxBtn,fxOn); beep(fxOn?680:300,.05); });

  // confetti
  const conf=$("#confetti"), ctx=conf.getContext("2d");
  const DPR=window.devicePixelRatio||1;
  function resize(){ conf.width=innerWidth*DPR; conf.height=innerHeight*DPR; }
  addEventListener("resize", resize); resize();

  let parts=[];
  function burst(x=innerWidth/2, y=innerHeight/2, n=190){
    if(!fxOn) return;
    const colors=["#ff3b5c","#22d38a","#ffd24a","#2f7bff","#101326"];
    for(let i=0;i<n;i++){
      const a=Math.random()*Math.PI*2;
      const sp=2+Math.random()*6.2;
      parts.push({
        x:x*DPR,y:y*DPR,
        vx:Math.cos(a)*sp*DPR,
        vy:Math.sin(a)*sp*DPR-(2.2*DPR),
        g:0.12*DPR,
        s:(2+Math.random()*4)*DPR,
        life:190+Math.random()*140,
        c:colors[(Math.random()*colors.length)|0],
        rot:Math.random()*Math.PI
      });
    }
  }
  function loop(){
    ctx.clearRect(0,0,conf.width,conf.height);
    for(let i=parts.length-1;i>=0;i--){
      const p=parts[i];
      p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.life--; p.rot+=0.16;
      ctx.globalAlpha=Math.max(0,Math.min(1,p.life/250));
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
      ctx.fillStyle=p.c;
      ctx.fillRect(-p.s,-p.s/2,p.s*2,p.s);
      ctx.restore();
      if(p.life<=0 || p.y>conf.height+600) parts.splice(i,1);
    }
    requestAnimationFrame(loop);
  }
  loop();

  // normalize
  const norm = (s)=>String(s??"").trim();
  const normLoose = (s)=>norm(s).toLowerCase().replace(/\s+/g," ").trim();
  const normTight = (s)=>norm(s).toLowerCase().replace(/\s+/g,"").trim();

  function setMsg(el, type, txt){
    el.className = "micro " + (type||"");
    el.textContent = txt || "";
  }

  /* =========================
     Build Pages
     ========================= */
  const pagesEl = $("#pages");
  const totalPages = 1 + CONFIG.questions.length + 1;

  const pageHTML = [];

  // Intro
  pageHTML.push(`
    <section class="page active" data-i="1">
      <div class="titleCenter">
        <h1>${CONFIG.title}</h1>
        <div class="sub">${CONFIG.subtitle}</div>
      </div>

      <div class="card tint4" style="margin-top:10px;">
        <div class="q" style="text-align:center;">Pr√©nom / pseudo</div>
        <div class="row" style="margin-top:14px;">
          <input id="name" placeholder="ex : Rola" maxlength="18"/>
          <button class="primary" id="start">Entrer</button>
        </div>
        <div class="micro" style="text-align:center;">${CONFIG.questions.length} questions ¬∑ 1 coffre</div>
      </div>

      <div class="nav">
        <div class="bar"><div class="fill" id="fill" style="width:${Math.round((1/totalPages)*100)}%"></div></div>
        <div></div>
      </div>
    </section>
  `);

  // Questions
  CONFIG.questions.forEach((q, idx) => {
    const pageIndex = 2 + idx;
    const qClass = q.promptClass ? `q ${q.promptClass}` : "q";

    pageHTML.push(`
      <section class="page" data-i="${pageIndex}">
        <h2>${q.label}</h2>
        <div class="card ${q.tint || "tint4"}">
          <div class="${qClass}">${q.promptHTML}</div>

          <div class="row" style="margin-top:14px; justify-content:flex-start">
            <input id="a-${q.id}" placeholder="${q.placeholder || "R√©ponse"}" />
            <button class="primary" id="check-${q.id}">OK</button>
            <button class="soft" id="hint-${q.id}">Indice</button>
          </div>

          <div class="micro" id="m-${q.id}"></div>
        </div>

        <div class="nav">
          <div class="bar"><div class="fill" style="width:${Math.round((pageIndex/totalPages)*100)}%"></div></div>
          <div class="row" style="justify-content:flex-end">
            <button class="soft" data-back>‚Üê</button>
            <button class="primary" id="next-${q.id}" disabled>‚Üí</button>
          </div>
        </div>
      </section>
    `);
  });

  // Final
  const finalIndex = totalPages;
  pageHTML.push(`
    <section class="page" data-i="${finalIndex}">
      <h2>üéÅ</h2>

      <div class="finalGrid">
        <div class="card tint2">
          <div class="q" style="text-align:center;">Code</div>

          <div style="display:grid;place-items:center;margin-top:12px;">
            <div id="codeBox"
              style="font-size:22px; font-weight:900; letter-spacing:.14em;
                     display:inline-block; padding:14px 16px; border-radius:18px;
                     border:2px dashed rgba(0,0,0,.16); background:#fff; box-shadow: var(--shadow2);">
              ‚Äî
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="primary" id="openChest">Ouvrir</button>
            <button class="soft" id="copy">Copier</button>
            <button class="soft" id="replay">Rejouer</button>
          </div>

          <div class="micro" style="text-align:center;">
            Bien jou√©!!
          </div>
        </div>

        <div class="chestCard">
          <div id="chestWrap" class="shake" style="display:grid; place-items:center; gap:8px;">
            <svg id="chest" width="250" height="210" viewBox="0 0 240 200" aria-label="coffre">
              <defs>
                <linearGradient id="wood" x1="0" x2="1">
                  <stop offset="0" stop-color="#ffd24a" stop-opacity=".55"/>
                  <stop offset="1" stop-color="#ff3b5c" stop-opacity=".16"/>
                </linearGradient>
                <linearGradient id="lid" x1="0" x2="1">
                  <stop offset="0" stop-color="#2f7bff" stop-opacity=".22"/>
                  <stop offset="1" stop-color="#22d38a" stop-opacity=".24"/>
                </linearGradient>
              </defs>

              <g id="lidGroup" style="transform-origin: 60px 86px;">
                <path d="M55 68 Q120 30 185 68 L175 90 Q120 58 65 90 Z"
                  fill="url(#lid)" stroke="rgba(0,0,0,.16)" stroke-width="3"/>
                <rect x="110" y="66" width="20" height="18" rx="6"
                  fill="rgba(0,0,0,.08)" stroke="rgba(0,0,0,.16)" stroke-width="2"/>
              </g>

              <path d="M60 90 Q120 130 180 90 L190 150 Q120 188 50 150 Z"
                fill="url(#wood)" stroke="rgba(0,0,0,.16)" stroke-width="3"/>

              <rect x="112" y="112" width="16" height="22" rx="6"
                fill="rgba(255,255,255,.56)" stroke="rgba(0,0,0,.16)" stroke-width="2"/>
            </svg>
          </div>

          <svg class="burstCoins" id="burst" viewBox="0 0 300 220" aria-hidden="true">
            <circle cx="70" cy="78" r="10" fill="rgba(255,210,74,.95)"/>
            <circle cx="115" cy="52" r="8" fill="rgba(47,123,255,.85)"/>
            <circle cx="168" cy="62" r="9" fill="rgba(34,211,138,.85)"/>
            <circle cx="214" cy="88" r="10" fill="rgba(255,59,92,.80)"/>
            <circle cx="150" cy="98" r="7" fill="rgba(0,0,0,.12)"/>
            <rect x="62" y="124" width="16" height="6" rx="3" fill="rgba(255,59,92,.72)"/>
            <rect x="118" y="146" width="18" height="6" rx="3" fill="rgba(34,211,138,.72)"/>
            <rect x="190" y="134" width="20" height="6" rx="3" fill="rgba(47,123,255,.72)"/>
          </svg>
        </div>
      </div>

      <div class="nav">
        <div class="bar"><div class="fill" style="width:100%"></div></div>
        <button class="soft" data-back>‚Üê</button>
      </div>
    </section>
  `);

  pagesEl.innerHTML = pageHTML.join("");

  /* =========================
     Navigation / Logic
     ========================= */
  const pages=[...$$(".page")];
  let idx=1;

  // ‚úÖ IMPORTANT: une seule d√©claration de fill (sinon page blanche)
  const fillBar=$("#fill");
  function setProgress(i){
    fillBar.style.width = Math.round((i/totalPages)*100) + "%";
  }
  function goTo(i){
    if(i<1||i>pages.length||i===idx) return;
    const cur=pages[idx-1], nxt=pages[i-1];
    cur.classList.add("out");
    setTimeout(()=>{
      cur.classList.remove("active","out");
      nxt.classList.add("active");
      idx=i;
      setProgress(i);
    }, 220);
    beep(i>idx?560:440,.05);
  }
  $$("[data-back]").forEach(b=>b.addEventListener("click", ()=>goTo(idx-1)));

  // start
  const nameIn=$("#name");
  $("#start").addEventListener("click", ()=>{
    if(!nameIn.value.trim()) nameIn.value="CPF";
    goTo(2);
    pop("‚ú®");
  });

  // bind each question
  CONFIG.questions.forEach((q, index) => {
    const input = $(`#a-${q.id}`);
    const msg = $(`#m-${q.id}`);
    const btnCheck = $(`#check-${q.id}`);
    const btnHint = $(`#hint-${q.id}`);
    const btnNext = $(`#next-${q.id}`);

    btnHint.addEventListener("click", ()=>{
      setMsg(msg,"", q.hint || "Indice");
      beep(640,.05);
    });

    btnCheck.addEventListener("click", ()=>{
      const raw = input ? input.value : "";
      const ok = validate(q, raw);
      if(ok){
        setMsg(msg,"ok","‚úì");
        winSound();
        burst(innerWidth*0.52, innerHeight*0.46, 220 + (index*15));
        btnNext.disabled = false;
        pop("GG");
      } else {
        setMsg(msg,"no","‚Ä¶");
        failSound();
        pop("Encore");
      }
    });

    btnNext.addEventListener("click", ()=>{
      goTo(2 + index + 1);
    });

    if(input){
      input.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){ btnCheck.click(); }
      });
    }
  });

  // final code
  const lastNextBtn = $(`#next-${CONFIG.questions[CONFIG.questions.length-1].id}`);
  if(lastNextBtn){
    lastNextBtn.addEventListener("click", ()=>{
      const nm=(nameIn.value||"CPF").trim();
      const tag = nm.toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6) || "CPF";
      const stamp = String(Math.floor(100 + Math.random()*900));
      $("#codeBox").textContent = `${tag}-${stamp}`;
      goTo(totalPages);
      burst(innerWidth*0.52, innerHeight*0.42, 320);
      winSound();
    });
  }

  // chest open
  const chestWrap=$("#chestWrap");
  const lidGroup=$("#lidGroup");
  const burstOverlay=$("#burst");
  let opened=false;

  $("#openChest").addEventListener("click", ()=>{
    if(opened) return;
    opened=true;
    chestWrap.classList.remove("shake");
    lidGroup.animate(
      [{transform:"rotate(0deg)"},{transform:"rotate(-28deg)"}],
      {duration:520, easing:"cubic-bezier(.2,.9,.2,1)", fill:"forwards"}
    );
    burstOverlay.classList.add("show");
    burst(innerWidth*0.74, innerHeight*0.48, 380);
    winSound();
    pop("Bravo ‚ú®");
  });

  $("#copy").addEventListener("click", async ()=>{
    const code=$("#codeBox").textContent;
    try{ await navigator.clipboard.writeText(code); pop("Copi√©"); burst(innerWidth*0.5, innerHeight*0.84, 120); beep(860,.06); }
    catch(e){ pop("Copie manuelle"); }
  });

  $("#replay").addEventListener("click", ()=>{
    CONFIG.questions.forEach(q=>{
      const i = $(`#a-${q.id}`); if(i) i.value="";
      const m = $(`#m-${q.id}`); if(m) setMsg(m,"","");
      const n = $(`#next-${q.id}`); if(n) n.disabled=true;
    });

    opened=false;
    burstOverlay.classList.remove("show");
    chestWrap.classList.add("shake");
    lidGroup.getAnimations().forEach(a=>a.cancel());
    lidGroup.style.transform="rotate(0deg)";

    pop("‚ú®");
    goTo(1);
  });

  // validation
  function validate(q, raw){
    const type = q.type;

    if(type === "letter"){
      const v = norm(raw).toUpperCase();
      if(!v) return false;
      return v === String(q.answer).toUpperCase();
    }

    if(type === "system"){
      const cleaned = norm(raw)
        .toLowerCase()
        .replace(/\s+/g,"")
        .replace(/x=/g,"")
        .replace(/y=/g,"")
        .replace(/,/g,";")
        .trim();
      return cleaned === String(q.answer).toLowerCase();
    }

    if(type === "code"){
      const v = normTight(raw).replace(/\D/g,"");
      return v === String(q.answer).replace(/\D/g,"");
    }

    if(type === "number"){
      const v = normTight(raw).replace(",",".");
      const a = Number(v);
      const b = Number(String(q.answer));
      if(Number.isFinite(a) && Number.isFinite(b)){
        return Math.abs(a-b) < 1e-9;
      }
      return v === normTight(String(q.answer));
    }

    // text
    const v = normLoose(raw);
    const target = normLoose(q.answer);
    return v === target;
  }

})();
</script>
</body>
</html>


